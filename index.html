<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flashcard Study App</title>
  <script>
    // /_sdk/element_sdk.js
(function () {
  let config = {};

  window.elementSdk = {
    init(api) {
      // Store defaults
      config = { ...(api?.defaultConfig || {}) };

      // Expose fake edit panel updates if needed
      window.__elementApi = api;
    },

    setConfig(newConfig) {
      config = { ...config, ...newConfig };

      // Notify app if config changes
      if (window.__elementApi?.onConfigChange) {
        window.__elementApi.onConfigChange(config);
      }
    },

    getConfig() {
      return { ...config };
    }
  };
})();
  </script>
<script>
(function () {
  const STORAGE_KEY = "flashcards_data";
  let handler = null;
  let data = [];

  function load() {
    try {
      data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    } catch {
      data = [];
    }
  }

  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function notify() {
    if (handler && typeof handler.onDataChanged === "function") {
      handler.onDataChanged([...data]);
    }
  }

  function generateId() {
    return "id_" + Date.now() + "_" + Math.random().toString(36).slice(2, 8);
  }

  window.dataSdk = {
    async init(h) {
      handler = h;
      load();
      notify();
      return { isOk: true };
    },

    async create(item) {
      const newItem = {
        ...item,
        id: generateId()
      };
      data.push(newItem);
      save();
      notify();
      return { isOk: true, item: newItem };
    },

    async delete({ id }, silent = false) {
     if (!id) return { isOk: false };
     data = data.filter(d => d.id !== id);
     save();
     if (!silent) notify();
     return { isOk: true };
    },

    async update(updatedItem) {
      if (!updatedItem?.id) return { isOk: false };

      const index = data.findIndex(d => d.id === updatedItem.id);
      if (index !== -1) {
        data[index] = updatedItem;
        save();
        notify();
      }
      return { isOk: true };
    },

    getAll() {
      return [...data];
    }
  };
})();
</script>
  <script src="tailwindcss.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }
    
    .slide-in {
      animation: slideIn 0.4s ease-out;
    }
    
    .card-3d {
      perspective: 1000px;
    }
    
    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }
    
    .card-inner.flipped {
      transform: rotateY(180deg);
    }
    
    .card-front, .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      border-radius: 1rem;
    }
    
    .card-back {
      transform: rotateY(180deg);
    }
    
    .category-card {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .category-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }
    
    .progress-bar {
      transition: width 0.4s ease;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    .modal-content {
      max-width: 500px;
      width: 100%;
      max-height: 90%;
      overflow-y: auto;
      border-radius: 1rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full"></div>
  <script>
   
   const AI_API_URL =
  "https://flashcards-ai-backend.onrender.com/api/generate-cards";

    const defaultConfig = {
      app_title: "Flashcard Study",
      app_subtitle: "Create custom subjects and master your knowledge",
      background_color: "#f0f4f8",
      card_background: "#ffffff",
      primary_color: "#2563eb",
      text_color: "#1e293b",
      secondary_color: "#64748b"
    };

    let config = { ...defaultConfig };
    let allData = [];
    let currentView = 'subjects'; // subjects, sets, cards, study
    let currentSubject = null;
    let currentSet = null;
    let currentCardIndex = 0;
    let isFlipped = false;
    let isLoading = false;

    const emojiOptions = ['üìö', 'üß™', 'üé®', 'üíª', 'üåç', 'üìê', 'üéµ', '‚öΩ', 'üî¨', 'üìñ', 'üé≠', 'üèõÔ∏è', 'üíº', 'üçé', 'üöÄ', 'üéØ', 'üí°', 'üîß', 'üåü', 'üé™'];

    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        renderApp();
      }
    };

    function getSubjects() {
      const subjectMap = new Map();
      allData.filter(item => item.type === 'subject').forEach(subject => {
        subjectMap.set(subject.subject_id, subject);
      });
      return Array.from(subjectMap.values());
    }

    function getSetsForSubject(subjectId) {
      const setMap = new Map();
      allData.filter(item => item.type === 'set' && item.subject_id === subjectId).forEach(set => {
        setMap.set(set.set_id, set);
      });
      return Array.from(setMap.values());
    }

    function getCardsForSet(setId) {
      return allData.filter(item => item.type === 'card' && item.set_id === setId);
    }

    function renderApp() {
      const app = document.getElementById('app');
      app.style.backgroundColor = config.background_color || defaultConfig.background_color;
      app.style.fontFamily = `${config.font_family || 'system-ui'}, -apple-system, sans-serif`;
      
      let content = '';
      if (currentView === 'subjects') {
        content = renderSubjectsView();
      } else if (currentView === 'sets') {
        content = renderSetsView();
      } else if (currentView === 'cards') {
        content = renderCardsView();
      } else if (currentView === 'study') {
        content = renderStudyView();
      }
      
      app.innerHTML = content;
      attachEventListeners();
    }

    function renderSubjectsView() {
      const subjects = getSubjects();
      const fontSize = config.font_size || 16;
      const titleColor = config.text_color || defaultConfig.text_color;
      const subtitleColor = config.secondary_color || defaultConfig.secondary_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const cardBg = config.card_background || defaultConfig.card_background;

      const subjectsHTML = subjects.map(subject => {
      const sets = getSetsForSubject(subject.subject_id);
       return `
          <div class="category-card p-6 rounded-2xl" data-subject-id="${subject.subject_id}" style="background: ${cardBg}; box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative;">
            <button class="delete-subject-btn" data-subject-id="${subject.subject_id}" style="position: absolute; top: 0.75rem; right: 0.75rem; color: ${subtitleColor}; font-size: ${fontSize * 1.2}px; background: none; border: none; cursor: pointer; padding: 0.25rem; line-height: 1;">√ó</button>
            <div class="flex items-center mb-3">
              <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4" style="background: linear-gradient(135deg, ${primaryColor}, ${adjustColor(primaryColor, -20)});">
                <span style="font-size: ${fontSize * 1.5}px;">${subject.subject_icon}</span>
              </div>
              <div>
                <h2 style="font-size: ${fontSize * 1.5}px; font-weight: 600; color: ${titleColor};">${subject.subject_name}</h2>
                <p style="font-size: ${fontSize * 0.875}px; color: ${subtitleColor};">${sets.length} set${sets.length !== 1 ? 's' : ''}</p>
              </div>
            </div>
          </div>
        `;
      }).join('');
     
      return `
        <div class="w-full h-full overflow-auto">
          <div class="min-h-full flex flex-col p-8">
            <div class="max-w-4xl w-full mx-auto fade-in">
              <div class="text-center mb-12">
                <h1 class="mb-4" style="font-size: ${fontSize * 2.5}px; font-weight: 700; color: ${titleColor};">
                  ${config.app_title || defaultConfig.app_title}
                </h1>
                <p style="font-size: ${fontSize * 1.1}px; color: ${subtitleColor};">
                  ${config.app_subtitle || defaultConfig.app_subtitle}
                </p>
              </div>
              
              <div class="mb-6">
                <button id="addSubjectBtn" class="w-full py-4 rounded-xl transition-all font-semibold" style="background: ${primaryColor}; color: white; font-size: ${fontSize * 1.1}px; box-shadow: 0 4px 12px rgba(37,99,235,0.3);">
                  + Add New Subject
                </button>
              </div>

              ${subjects.length === 0 ? `
                <div class="text-center py-12" style="color: ${subtitleColor};">
                  <p style="font-size: ${fontSize * 1.2}px;">No subjects yet. Create your first subject to get started!</p>
                </div>
              ` : `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  ${subjectsHTML}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function renderSetsView() {
      if (!currentSubject || !currentSubject.subject_id) {
      currentView = 'subjects';
      renderApp();
      return '';
      }

      const sets = getSetsForSubject(currentSubject.subject_id);
      const fontSize = config.font_size || 16;
      const titleColor = config.text_color || defaultConfig.text_color;
      const subtitleColor = config.secondary_color || defaultConfig.secondary_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const cardBg = config.card_background || defaultConfig.card_background;

      const setsHTML = sets.map(set => {
        const cards = getCardsForSet(set.set_id);
        return `
          <div class="category-card p-6 rounded-2xl" data-set-id="${set.set_id}" style="background: ${cardBg}; box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative;">
            <button class="delete-set-btn" data-set-id="${set.set_id}" style="position: absolute; top: 0.75rem; right: 0.75rem; color: ${subtitleColor}; font-size: ${fontSize * 1.2}px; background: none; border: none; cursor: pointer; padding: 0.25rem; line-height: 1;">√ó</button>
            <h3 style="font-size: ${fontSize * 1.3}px; font-weight: 600; color: ${titleColor}; margin-bottom: 0.5rem;">${set.set_name}</h3>
            <p style="font-size: ${fontSize * 0.875}px; color: ${subtitleColor};">${cards.length} card${cards.length !== 1 ? 's' : ''}</p>
            ${cards.length > 0 ? `
              <button class="study-set-btn mt-4 px-4 py-2 rounded-lg" data-set-id="${set.set_id}" style="background: ${primaryColor}; color: white; font-size: ${fontSize * 0.875}px;">
                Study Now
              </button>
            ` : ''}
          </div>
        `;
      }).join('');

      return `
        <div class="w-full h-full overflow-auto">
          <div class="min-h-full flex flex-col p-6">
            <div class="max-w-4xl w-full mx-auto">
              <div class="flex items-center justify-between mb-8 slide-in">
                <button id="backToSubjectsBtn" class="px-4 py-2 rounded-lg transition-all" style="background: ${cardBg}; color: ${titleColor}; font-size: ${fontSize}px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                  ‚Üê Back
                </button>
                <div class="text-center">
                  <div style="font-size: ${fontSize * 2}px; margin-bottom: 0.25rem;">${currentSubject.subject_icon}</div>
                  <h2 style="font-size: ${fontSize * 1.8}px; font-weight: 600; color: ${titleColor};">${currentSubject.subject_name}</h2>
                </div>
                <div style="width: 80px;"></div>
              </div>

              <div class="mb-6">
                <button id="addSetBtn" class="w-full py-4 rounded-xl transition-all font-semibold" style="background: ${primaryColor}; color: white; font-size: ${fontSize * 1.1}px; box-shadow: 0 4px 12px rgba(37,99,235,0.3);">
                  + Add New Set
                </button>
              </div>

              ${sets.length === 0 ? `
                <div class="text-center py-12" style="color: ${subtitleColor};">
                  <p style="font-size: ${fontSize * 1.2}px;">No sets yet. Create your first set!</p>
                </div>
              ` : `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  ${setsHTML}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function renderCardsView() {
       if (!currentSet || !currentSet.set_id) {
            currentView = 'sets';
            renderApp();
            return '';
      }
      const cards = getCardsForSet(currentSet.set_id);
      const fontSize = config.font_size || 16;
      const titleColor = config.text_color || defaultConfig.text_color;
      const subtitleColor = config.secondary_color || defaultConfig.secondary_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const cardBg = config.card_background || defaultConfig.card_background;

      const cardsHTML = cards.map(card => `
        <div class="p-4 rounded-xl" style="background: ${cardBg}; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position: relative;">
          <button class="delete-card-btn" data-id="${card.id}" style="position: absolute; top: 0.5rem; right: 0.5rem; color: ${subtitleColor}; font-size: ${fontSize * 1.2}px; background: none; border: none; cursor: pointer; padding: 0.25rem; line-height: 1;">√ó</button>
          <div style="margin-bottom: 0.75rem;">
            <p style="font-size: ${fontSize * 0.75}px; color: ${primaryColor}; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">Q</p>
            <p style="font-size: ${fontSize}px; color: ${titleColor};">${card.question}</p>
          </div>
          <div>
            <p style="font-size: ${fontSize * 0.75}px; color: ${primaryColor}; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">A</p>
            <p style="font-size: ${fontSize}px; color: ${subtitleColor};">${card.answer}</p>
          </div>
        </div>
      `).join('');

      return `
        <div class="w-full h-full overflow-auto">
          <div class="min-h-full flex flex-col p-6">
            <div class="max-w-4xl w-full mx-auto">
              <div class="flex items-center justify-between mb-8 slide-in">
                <button id="backToSetsBtn" class="px-4 py-2 rounded-lg transition-all" style="background: ${cardBg}; color: ${titleColor}; font-size: ${fontSize}px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                  ‚Üê Back
                </button>
                <div class="text-center">
                  <h2 style="font-size: ${fontSize * 1.8}px; font-weight: 600; color: ${titleColor};">${currentSet.set_name}</h2>
                  <p style="font-size: ${fontSize * 0.875}px; color: ${subtitleColor};">${cards.length} card${cards.length !== 1 ? 's' : ''}</p>
                </div>
                <div style="width: 80px;"></div>
              </div>

<div class="mb-6 flex gap-3 relative z-10">
  <button id="addCardBtn" class="flex-1 py-4 rounded-xl transition-all font-semibold"
    style="background: ${primaryColor}; color: white; font-size: ${fontSize * 1.1}px;">
    + Add Card
  </button>

  <button id="aiGenerateBtn" class="flex-1 py-4 rounded-xl transition-all font-semibold"
    style="background:#0f172a;color:white;">
    ü§ñ Generate with AI
  </button>

  <button id="importCardsJsonBtn" class="flex-1 py-4 rounded-xl transition-all font-semibold"
    style="background:#e2e8f0;color:#1e293b;">
    üì§ Import Cards (JSON)
  </button>

  ${cards.length > 0 ? `
    <button id="studyCardsBtn" class="flex-1 py-4 rounded-xl transition-all font-semibold"
      style="background: ${cardBg}; color: ${titleColor}; font-size: ${fontSize * 1.1}px;">
      Study Set
    </button>
  ` : ''}
</div>



${cards.length === 0 ? `
  <div class="text-center py-12" style="color: ${subtitleColor};">
    <p style="font-size: ${fontSize * 1.2}px;">
      No cards yet. Add your first flashcard!
    </p>
  </div>
` : `
  <div class="grid grid-cols-1 gap-4">
    ${cardsHTML}
  </div>
`}
            </div>
          </div>
        </div>
      `;
    }

    function renderStudyView() {
      const cards = getCardsForSet(currentSet.set_id);
      if (cards.length === 0) {
        currentView = 'cards';
        renderApp();
        return;
      }

      const card = cards[currentCardIndex];
      const fontSize = config.font_size || 16;
      const titleColor = config.text_color || defaultConfig.text_color;
      const subtitleColor = config.secondary_color || defaultConfig.secondary_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const cardBg = config.card_background || defaultConfig.card_background;
      const progress = ((currentCardIndex + 1) / cards.length) * 100;

      return `
        <div class="w-full h-full overflow-auto">
          <div class="min-h-full flex flex-col p-6">
            <div class="max-w-3xl w-full mx-auto flex flex-col" style="height: 100%;">
              <div class="flex items-center justify-between mb-6 slide-in">
                <button id="backToCardsBtn" class="px-4 py-2 rounded-lg transition-all" style="background: ${cardBg}; color: ${titleColor}; font-size: ${fontSize}px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                  ‚Üê Back
                </button>
                <div class="text-center">
                  <h2 style="font-size: ${fontSize * 1.5}px; font-weight: 600; color: ${titleColor};">${currentSet.set_name}</h2>
                  <p style="font-size: ${fontSize * 0.875}px; color: ${subtitleColor};">Card ${currentCardIndex + 1} of ${cards.length}</p>
                </div>
                <div style="width: 80px;"></div>
              </div>
              
              <div class="w-full rounded-full mb-6" style="background: rgba(0,0,0,0.1); height: 8px;">
                <div class="progress-bar h-full rounded-full" style="width: ${progress}%; background: ${primaryColor};"></div>
              </div>
              
              <div class="flex-1 flex items-center justify-center mb-6">
                <div class="card-3d w-full" style="max-width: 600px; height: 400px;">
                  <div id="cardInner" class="card-inner">
                    <div class="card-front" style="background: ${cardBg}; box-shadow: 0 8px 24px rgba(0,0,0,0.12);">
                      <div class="text-center">
                        <p style="font-size: ${fontSize * 0.75}px; color: ${primaryColor}; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 1rem;">Question</p>
                        <p style="font-size: ${fontSize * 1.5}px; color: ${titleColor}; font-weight: 500; line-height: 1.6;">${card.question}</p>
                      </div>
                    </div>
                    <div class="card-back" style="background: ${primaryColor};">
                      <div class="text-center">
                        <p style="font-size: ${fontSize * 0.75}px; color: rgba(255,255,255,0.9); font-weight: 600; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 1rem;">Answer</p>
                        <p style="font-size: ${fontSize * 1.5}px; color: white; font-weight: 500; line-height: 1.6;">${card.answer}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="flex flex-col gap-4">
                <button id="flipBtn" class="w-full py-4 rounded-xl transition-all font-semibold" style="background: ${primaryColor}; color: white; font-size: ${fontSize * 1.1}px; box-shadow: 0 4px 12px rgba(37,99,235,0.3);">
                  Flip Card
                </button>
                
                <div class="flex gap-4">
                  <button id="prevBtn" class="flex-1 py-3 rounded-xl transition-all" style="background: ${cardBg}; color: ${titleColor}; font-size: ${fontSize}px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); opacity: ${currentCardIndex === 0 ? '0.5' : '1'}; cursor: ${currentCardIndex === 0 ? 'not-allowed' : 'pointer'};" ${currentCardIndex === 0 ? 'disabled' : ''}>
                    ‚Üê Previous
                  </button>
                  <button id="nextBtn" class="flex-1 py-3 rounded-xl transition-all" style="background: ${cardBg}; color: ${titleColor}; font-size: ${fontSize}px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); opacity: ${currentCardIndex === cards.length - 1 ? '0.5' : '1'}; cursor: ${currentCardIndex === cards.length - 1 ? 'not-allowed' : 'pointer'};" ${currentCardIndex === cards.length - 1 ? 'disabled' : ''}>
                    Next ‚Üí
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function showAddSubjectModal() {
      const fontSize = config.font_size || 16;
      const titleColor = config.text_color || defaultConfig.text_color;
      const subtitleColor = config.secondary_color || defaultConfig.secondary_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const cardBg = config.card_background || defaultConfig.card_background;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="background: ${cardBg}; padding: 2rem;">
          <h2 style="font-size: ${fontSize * 1.8}px; font-weight: 600; color: ${titleColor}; margin-bottom: 1.5rem;">Add New Subject</h2>
          
          <form id="addSubjectForm">
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: ${fontSize * 0.875}px; font-weight: 500; color: ${titleColor}; margin-bottom: 0.5rem;">Subject Name</label>
              <input type="text" id="subjectNameInput" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 0.5rem; font-size: ${fontSize}px; color: ${titleColor};" placeholder="e.g., Biology, History...">
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: ${fontSize * 0.875}px; font-weight: 500; color: ${titleColor}; margin-bottom: 0.5rem;">Choose Icon</label>
              <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem;">
                ${emojiOptions.map((emoji, idx) => `
                  <button type="button" class="emoji-btn" data-emoji="${emoji}" style="padding: 0.75rem; border: 2px solid ${idx === 0 ? primaryColor : '#e2e8f0'}; border-radius: 0.5rem; font-size: ${fontSize * 1.5}px; cursor: pointer; background: ${cardBg}; transition: all 0.2s;">
                    ${emoji}
                  </button>
                `).join('')}
              </div>
              <input type="hidden" id="selectedEmoji" value="${emojiOptions[0]}">
            </div>

            <div style="display: flex; gap: 1rem;">
              <button type="button" id="cancelSubjectBtn" style="flex: 1; padding: 0.75rem; border-radius: 0.5rem; font-size: ${fontSize}px; background: #e2e8f0; color: ${titleColor}; border: none; cursor: pointer;">
                Cancel
              </button>
              <button type="submit" id="submitSubjectBtn" style="flex: 1; padding: 0.75rem; border-radius: 0.5rem; font-size: ${fontSize}px; background: ${primaryColor}; color: white; border: none; cursor: pointer; font-weight: 600;">
                <span id="submitSubjectText">Add Subject</span>
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      const emojiButtons = modal.querySelectorAll('.emoji-btn');
      const selectedEmojiInput = modal.querySelector('#selectedEmoji');
      
      emojiButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          emojiButtons.forEach(b => b.style.borderColor = '#e2e8f0');
          btn.style.borderColor = primaryColor;
          selectedEmojiInput.value = btn.dataset.emoji;
        });
      });

      modal.querySelector('#cancelSubjectBtn').addEventListener('click', () => {
        modal.remove();
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });

      modal.querySelector('#addSubjectForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (allData.filter(d => d.type === 'subject').length >= 999) {
          showToast('Maximum limit of 999 subjects reached');
          return;
        }

        const submitBtn = modal.querySelector('#submitSubjectBtn');
        const submitText = modal.querySelector('#submitSubjectText');
        submitBtn.disabled = true;
        submitText.innerHTML = '<span class="spinner"></span>';

        const subjectName = modal.querySelector('#subjectNameInput').value;
        const subjectIcon = selectedEmojiInput.value;
        const subjectId = 'subj_' + Date.now();

        const result = await window.dataSdk.create({
          type: 'subject',
          subject_id: subjectId,
          subject_name: subjectName,
          subject_icon: subjectIcon,
          set_id: '',
          set_name: '',
          question: '',
          answer: '',
          created_at: new Date().toISOString()
        });

if (result.isOk) {
  modal.remove();
  renderApp();
}
 else {
          submitBtn.disabled = false;
          submitText.textContent = 'Add Subject';
          showToast('Failed to add subject. Please try again.');
        }
      });
    }
     
function importCardsFromJsonForCurrentSet() {
  if (!currentSet?.set_id) {
    showToast('No set selected');
    return;
  }

  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';

  input.addEventListener('change', async () => {
    const file = input.files[0];
    if (!file) return;

    try {
      const text = await file.text();
      const json = JSON.parse(text);

      if (!Array.isArray(json.cards)) {
        throw new Error('Invalid format');
      }

      for (const card of json.cards) {
        if (!card.question || !card.answer) continue;

        await window.dataSdk.create({
          type: 'card',
          subject_id: '',
          subject_name: '',
          subject_icon: '',
          set_id: currentSet.set_id,
          set_name: '',
          question: card.question,
          answer: card.answer,
          created_at: new Date().toISOString()
        });
      }

      showToast(`Imported ${json.cards.length} cards`);
    } catch (err) {
      console.error(err);
      showToast('Invalid JSON file');
    }
  });

  input.click();
}

    function showAddSetModal() {
      const fontSize = config.font_size || 16;
      const titleColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const cardBg = config.card_background || defaultConfig.card_background;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="background: ${cardBg}; padding: 2rem;">
          <h2 style="font-size: ${fontSize * 1.8}px; font-weight: 600; color: ${titleColor}; margin-bottom: 1.5rem;">Add New Set</h2>
          
          <form id="addSetForm">
            <div style="margin-bottom: 1.5rem;">
              <label for="setNameInput" style="display: block; font-size: ${fontSize * 0.875}px; font-weight: 500; color: ${titleColor}; margin-bottom: 0.5rem;">Set Name</label>
              <input type="text" id="setNameInput" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 0.5rem; font-size: ${fontSize}px; color: ${titleColor};" placeholder="e.g., Chapter 1, Vocabulary...">
            </div>

            <div style="display: flex; gap: 1rem;">
              <button type="button" id="cancelSetBtn" style="flex: 1; padding: 0.75rem; border-radius: 0.5rem; font-size: ${fontSize}px; background: #e2e8f0; color: ${titleColor}; border: none; cursor: pointer;">
                Cancel
              </button>
              <button type="submit" id="submitSetBtn" style="flex: 1; padding: 0.75rem; border-radius: 0.5rem; font-size: ${fontSize}px; background: ${primaryColor}; color: white; border: none; cursor: pointer; font-weight: 600;">
                <span id="submitSetText">Add Set</span>
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      modal.querySelector('#cancelSetBtn').addEventListener('click', () => {
        modal.remove();
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });

      modal.querySelector('#addSetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (allData.filter(d => d.type === 'set').length >= 999) {
          showToast('Maximum limit of 999 sets reached');
          return;
        }

        const submitBtn = modal.querySelector('#submitSetBtn');
        const submitText = modal.querySelector('#submitSetText');
        submitBtn.disabled = true;
        submitText.innerHTML = '<span class="spinner"></span>';

        const setName = modal.querySelector('#setNameInput').value;
        const setId = 'set_' + Date.now();

        const result = await window.dataSdk.create({
          type: 'set',
          subject_id: currentSubject.subject_id,
          subject_name: '',
          subject_icon: '',
          set_id: setId,
          set_name: setName,
          question: '',
          answer: '',
          created_at: new Date().toISOString()
        });

        if (result.isOk) {
          modal.remove();
        } else {
          submitBtn.disabled = false;
          submitText.textContent = 'Add Set';
          showToast('Failed to add set. Please try again.');
        }
      });
    }

    function showAddCardModal() {
      const fontSize = config.font_size || 16;
      const titleColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const cardBg = config.card_background || defaultConfig.card_background;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="background: ${cardBg}; padding: 2rem;">
          <h2 style="font-size: ${fontSize * 1.8}px; font-weight: 600; color: ${titleColor}; margin-bottom: 1.5rem;">Add New Card</h2>
          
          <form id="addCardForm">
            <div style="margin-bottom: 1.5rem;">
              <label for="questionInput" style="display: block; font-size: ${fontSize * 0.875}px; font-weight: 500; color: ${titleColor}; margin-bottom: 0.5rem;">Question</label>
              <textarea id="questionInput" required rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 0.5rem; font-size: ${fontSize}px; color: ${titleColor}; resize: vertical;" placeholder="Enter the question..."></textarea>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <label for="answerInput" style="display: block; font-size: ${fontSize * 0.875}px; font-weight: 500; color: ${titleColor}; margin-bottom: 0.5rem;">Answer</label>
              <textarea id="answerInput" required rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 0.5rem; font-size: ${fontSize}px; color: ${titleColor}; resize: vertical;" placeholder="Enter the answer..."></textarea>
            </div>

            <div style="display: flex; gap: 1rem;">
              <button type="button" id="cancelCardBtn" style="flex: 1; padding: 0.75rem; border-radius: 0.5rem; font-size: ${fontSize}px; background: #e2e8f0; color: ${titleColor}; border: none; cursor: pointer;">
                Cancel
              </button>
              <button type="submit" id="submitCardBtn" style="flex: 1; padding: 0.75rem; border-radius: 0.5rem; font-size: ${fontSize}px; background: ${primaryColor}; color: white; border: none; cursor: pointer; font-weight: 600;">
                <span id="submitCardText">Add Card</span>
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      modal.querySelector('#cancelCardBtn').addEventListener('click', () => {
        modal.remove();
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });

      modal.querySelector('#addCardForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (allData.filter(d => d.type === 'card').length >= 999) {
          showToast('Maximum limit of 999 cards reached');
          return;
        }

        const submitBtn = modal.querySelector('#submitCardBtn');
        const submitText = modal.querySelector('#submitCardText');
        submitBtn.disabled = true;
        submitText.innerHTML = '<span class="spinner"></span>';

        const question = modal.querySelector('#questionInput').value;
        const answer = modal.querySelector('#answerInput').value;

        const result = await window.dataSdk.create({
  type: 'card',
  subject_id: currentSubject.subject_id,
  subject_name: currentSubject.subject_name,
  subject_icon: currentSubject.subject_icon,
  set_id: currentSet.set_id,
  set_name: currentSet.set_name,
  question: question,
  answer: answer,
  created_at: new Date().toISOString()
});


        if (result.isOk) {
          modal.remove();
        } else {
          submitBtn.disabled = false;
          submitText.textContent = 'Add Card';
          showToast('Failed to add card. Please try again.');
        }
      });
    }

async function generateCardsWithAI(topic, count) {
  if (!currentSet?.set_id) {
    showToast("No set selected");
    return false;
  }

  showAILoading();

  try {
    const res = await fetch(AI_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ topic, count })
    });

    const json = await res.json();
    if (!Array.isArray(json.cards)) {
      throw new Error("Invalid AI response");
    }

    for (const card of json.cards) {
      await window.dataSdk.create({
        type: "card",
        subject_id: currentSubject.subject_id,
        subject_name: currentSubject.subject_name,
        subject_icon: currentSubject.subject_icon,
        set_id: currentSet.set_id,
        set_name: currentSet.set_name,
        question: card.question,
        answer: card.answer,
        created_at: new Date().toISOString()
      });
    }

    // force UI refresh
    dataHandler.onDataChanged(window.dataSdk.getAll());
showToast(`Added ${json.cards.length} cards`);
await loadAllData();
renderApp();
   
    return true; // ‚úÖ THIS WAS MISSING
  } catch (err) {
    console.error(err);
    showToast("AI generation failed");
    return false; // ‚úÖ ALSO IMPORTANT
  } finally {
    hideAILoading();
  }
}
async function loadAllData() {
  const result = await window.dataSdk.list();
  if (result.isOk) {
    allData = result.value;
  }
}


   
function showAIGenerateModal() {
  if (!currentSet?.set_id) {
    showToast("No set selected");
    return;
  }

  const fontSize = config.font_size || 16;
  const titleColor = config.text_color || defaultConfig.text_color;
  const primaryColor = config.primary_color || defaultConfig.primary_color;
  const cardBg = config.card_background || defaultConfig.card_background;

  let isGenerating = false;

  const modal = document.createElement("div");
  modal.className = "modal-overlay";

  modal.innerHTML = `
    <div class="modal-content" style="background:${cardBg};padding:2rem;">
      <h2 style="font-size:${fontSize * 1.8}px;font-weight:600;color:${titleColor};margin-bottom:1rem;">
        ü§ñ Generate Flashcards with AI
      </h2>

      <form id="aiGenerateForm">
        <div style="margin-bottom:1rem;">
          <label style="font-size:${fontSize * 0.875}px;font-weight:500;color:${titleColor};">
            Topic
          </label>
          <input
            id="aiTopicInput"
            required
            value="${currentSet.set_name}"
            style="width:100%;padding:0.75rem;border:2px solid #e2e8f0;border-radius:0.5rem;font-size:${fontSize}px;"
            placeholder="e.g. Photosynthesis, World War II..."
          />
        </div>
        <div style="margin-bottom:1rem;">
  <label style="font-size:${fontSize * 0.875}px;font-weight:500;color:${titleColor};">
    Number of cards
  </label>
  <input
    id="aiCountInput"
    type="number"
    min="1"
    max="50"
    value="15"
    style="width:100%;padding:0.75rem;border:2px solid #e2e8f0;border-radius:0.5rem;font-size:${fontSize}px;"
  />
</div>


        <div style="display:flex;gap:1rem;">
          <button type="button" id="cancelAIBtn"
            style="flex:1;padding:0.75rem;border-radius:0.5rem;background:#e2e8f0;">
            Cancel
          </button>
          <button type="submit" id="submitAIBtn"
            style="flex:1;padding:0.75rem;border-radius:0.5rem;background:${primaryColor};color:white;font-weight:600;">
            <span id="submitAIText">Generate</span>
          </button>
        </div>
      </form>
    </div>
  `;

  document.body.appendChild(modal);

  modal.querySelector("#cancelAIBtn").onclick = () => modal.remove();
  modal.onclick = e => e.target === modal && modal.remove();

  modal.querySelector("#aiGenerateForm").addEventListener("submit", async e => {
  e.preventDefault();

  if (isGenerating) return;

  const btn = modal.querySelector("#submitAIBtn");
  const text = modal.querySelector("#submitAIText");
  const topic = modal.querySelector("#aiTopicInput").value;
  const count = Number(modal.querySelector("#aiCountInput").value) || 15;

  isGenerating = true;
  text.innerHTML = `<span class="spinner"></span>`;

  try {
    const success = await generateCardsWithAI(topic, count);
    if (success) {
      modal.remove();
    } else {
      isGenerating = false;
      text.textContent = "Generate";
    }
  } catch {
    isGenerating = false;
    text.textContent = "Generate";
  }
});
}

let aiLoadingEl = null;

function showAILoading() {
  if (aiLoadingEl) return;

  aiLoadingEl = document.createElement("div");
  aiLoadingEl.className = "p-4 rounded-xl text-center mb-4";
  aiLoadingEl.style.background = "#0f172a";
  aiLoadingEl.style.color = "white";
  aiLoadingEl.style.fontWeight = "600";
  aiLoadingEl.textContent = "ü§ñ AI is generating flashcards‚Ä¶";

  document.getElementById("app")?.prepend(aiLoadingEl);
}


function hideAILoading() {
  aiLoadingEl?.remove();
  aiLoadingEl = null;
}


    function showToast(message) {
      const fontSize = config.font_size || 16;
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: #1e293b;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        font-size: ${fontSize}px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 2000;
        animation: slideIn 0.3s ease-out;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'fadeIn 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function attachEventListeners() {
      const addSubjectBtn = document.getElementById('addSubjectBtn');
      if (addSubjectBtn) {
        addSubjectBtn.addEventListener('click', showAddSubjectModal);
      }

      const addSetBtn = document.getElementById('addSetBtn');
      if (addSetBtn) {
        addSetBtn.addEventListener('click', showAddSetModal);
      }

      const addCardBtn = document.getElementById('addCardBtn');
      if (addCardBtn) {
        addCardBtn.addEventListener('click', showAddCardModal);
      }

      const importCardsJsonBtn = document.getElementById('importCardsJsonBtn');
     if (importCardsJsonBtn) {
      importCardsJsonBtn.addEventListener('click', importCardsFromJsonForCurrentSet);
     }

      const categoryCards = document.querySelectorAll('.category-card');
      categoryCards.forEach(card => {
        if (card.dataset.subjectId) {
          card.addEventListener('click', (e) => {
            if (!e.target.classList.contains('delete-subject-btn')) {
              const subjectId = card.dataset.subjectId;
              currentSubject = getSubjects().find(s => s.subject_id === subjectId);
              currentView = 'sets';
              renderApp();
            }
          });
        } else if (card.dataset.setId) {
          card.addEventListener('click', (e) => {
            if (!e.target.classList.contains('delete-set-btn') && !e.target.classList.contains('study-set-btn')) {
              const setId = card.dataset.setId;
              currentSet = getSetsForSubject(currentSubject.subject_id).find(s => s.set_id === setId);
              currentView = 'cards';
              renderApp();
            }
          });
        }
      });

      const deleteSubjectBtns = document.querySelectorAll('.delete-subject-btn');
      deleteSubjectBtns.forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const subjectId = btn.dataset.subjectId;
          const subject = allData.find(d => d.type === 'subject' && d.subject_id === subjectId);
          
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></span>';

          const itemsToDelete = allData.filter(d => 
            (d.type === 'subject' && d.subject_id === subjectId) ||
            (d.type === 'set' && d.subject_id === subjectId) ||
            (d.type === 'card' && allData.some(s => s.type === 'set' && s.set_id === d.set_id && s.subject_id === subjectId))
          );
         
         for (const item of itemsToDelete) {
          await window.dataSdk.delete({ id: item.id }, true);
         }
         window.dataSdk.getAll(); // optional
         dataHandler.onDataChanged(window.dataSdk.getAll());

          if (currentSubject?.subject_id === subjectId) {
              currentSubject = null;
              currentView = 'subjects';
           }
        });
      });

      const deleteSetBtns = document.querySelectorAll('.delete-set-btn');
      deleteSetBtns.forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const setId = btn.dataset.setId;
          
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></span>';

          const itemsToDelete = allData.filter(d => 
            (d.type === 'set' && d.set_id === setId) ||
            (d.type === 'card' && d.set_id === setId)
          );

          for (const item of itemsToDelete) {
            await window.dataSdk.delete({ id: item.id });
          }
        });
      });
     
     const deleteCardBtns = document.querySelectorAll('.delete-card-btn');
     deleteCardBtns.forEach(btn => {
      btn.addEventListener('click', async (e) => {
       e.stopPropagation();
       
       const id = btn.dataset.id;
       
       btn.disabled = true;
       btn.innerHTML =
        '<span class="spinner" style="width:16px;height:16px;border-width:2px;"></span>';
       await window.dataSdk.delete({ id });
      });
     });


      const studySetBtns = document.querySelectorAll('.study-set-btn');
      studySetBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const setId = btn.dataset.setId;
          currentSet = getSetsForSubject(currentSubject.subject_id).find(s => s.set_id === setId);
          currentCardIndex = 0;
          isFlipped = false;
          currentView = 'study';
          renderApp();
        });
      });

      const studyCardsBtn = document.getElementById('studyCardsBtn');
      if (studyCardsBtn) {
        studyCardsBtn.addEventListener('click', () => {
          currentCardIndex = 0;
          isFlipped = false;
          currentView = 'study';
          renderApp();
        });
      }

      const backToSubjectsBtn = document.getElementById('backToSubjectsBtn');
      if (backToSubjectsBtn) {
        backToSubjectsBtn.addEventListener('click', () => {
          currentView = 'subjects';
          currentSubject = null;
          renderApp();
        });
      }

      const backToSetsBtn = document.getElementById('backToSetsBtn');
      if (backToSetsBtn) {
        backToSetsBtn.addEventListener('click', () => {
          currentView = 'sets';
          currentSet = null;
          renderApp();
        });
      }

      const backToCardsBtn = document.getElementById('backToCardsBtn');
      if (backToCardsBtn) {
        backToCardsBtn.addEventListener('click', () => {
          currentView = 'cards';
          currentCardIndex = 0;
          isFlipped = false;
          renderApp();
        });
      }

      const flipBtn = document.getElementById('flipBtn');
      if (flipBtn) {
        flipBtn.addEventListener('click', () => {
          const cardInner = document.getElementById('cardInner');
          isFlipped = !isFlipped;
          if (isFlipped) {
            cardInner.classList.add('flipped');
          } else {
            cardInner.classList.remove('flipped');
          }
        });
      }

      const prevBtn = document.getElementById('prevBtn');
      if (prevBtn && currentCardIndex > 0) {
        prevBtn.addEventListener('click', () => {
          currentCardIndex--;
          isFlipped = false;
          renderApp();
        });
      }

      const nextBtn = document.getElementById('nextBtn');
      const cards = getCardsForSet(currentSet?.set_id || '');
      if (nextBtn && currentCardIndex < cards.length - 1) {
        nextBtn.addEventListener('click', () => {
          currentCardIndex++;
          isFlipped = false;
          renderApp();
        });
      }
     
     const aiGenerateBtn = document.getElementById("aiGenerateBtn");
     if (aiGenerateBtn) {
      aiGenerateBtn.addEventListener("click", showAIGenerateModal);
     }
    }

    function adjustColor(color, amount) {
      const num = parseInt(color.slice(1), 16);
      const r = Math.max(0, Math.min(255, (num >> 16) + amount));
      const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
      const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
      return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
    }

    async function onConfigChange(newConfig) {
      Object.assign(config, newConfig);
      renderApp();
    }

    function mapToCapabilities(cfg) {
      return {
        recolorables: [
          {
            get: () => cfg.background_color || defaultConfig.background_color,
            set: (value) => {
              cfg.background_color = value;
              window.elementSdk.setConfig({ background_color: value });
            }
          },
          {
            get: () => cfg.card_background || defaultConfig.card_background,
            set: (value) => {
              cfg.card_background = value;
              window.elementSdk.setConfig({ card_background: value });
            }
          },
          {
            get: () => cfg.text_color || defaultConfig.text_color,
            set: (value) => {
              cfg.text_color = value;
              window.elementSdk.setConfig({ text_color: value });
            }
          },
          {
            get: () => cfg.primary_color || defaultConfig.primary_color,
            set: (value) => {
              cfg.primary_color = value;
              window.elementSdk.setConfig({ primary_color: value });
            }
          },
          {
            get: () => cfg.secondary_color || defaultConfig.secondary_color,
            set: (value) => {
              cfg.secondary_color = value;
              window.elementSdk.setConfig({ secondary_color: value });
            }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => cfg.font_family || 'system-ui',
          set: (value) => {
            cfg.font_family = value;
            window.elementSdk.setConfig({ font_family: value });
          }
        },
        fontSizeable: {
          get: () => cfg.font_size || 16,
          set: (value) => {
            cfg.font_size = value;
            window.elementSdk.setConfig({ font_size: value });
          }
        }
      };
    }

    function mapToEditPanelValues(cfg) {
      return new Map([
        ["app_title", cfg.app_title || defaultConfig.app_title],
        ["app_subtitle", cfg.app_subtitle || defaultConfig.app_subtitle]
      ]);
    }

    (async () => {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities,
          mapToEditPanelValues
        });
      }

      if (window.dataSdk) {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          console.error('Failed to initialize data SDK');
        }
      }
    })();
  </script>
 </body>
 </html>
